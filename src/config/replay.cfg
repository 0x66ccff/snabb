-- replay.cfg -- replay switch

local ffi = require("ffi")

if #arg ~= 3 then
   io.stderr:write("Usage: replay <output> <input>\n")
   os.exit(1)
end

local output, input = arg[2], arg[3]
switch.trace(output)
for data, header, extra in pcap.records(input) do
   if extra.flags == 0 then -- input frame
      local frame = ffi.cast("char *", data)
      local packet = switch.makepacket(extra.port_id, frame, header.orig_len)
      -- Provision new switch ports on demand
      if switch.getport(extra.port_id) == nil then
	 switch.addport(extra.port_id, medium.Null)
      end
      switch.input(packet)
   end
end


-- -*- lua -*-